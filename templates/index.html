<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allocation Application</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f6f2f2; /* Light grey */
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            background-color: #ffffff; /* White */
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* Slightly darker shadow for contrast */
            width: 100%;
            max-width: 600px;
            box-sizing: border-box;
            margin-bottom: 20px;
            text-align: center; /* Center content within the container */
        }
        .logo {
            width: 250px; /* Increased width to make it 'elongated' (wider) */
            height: auto; /* Maintains aspect ratio */
            margin-bottom: 20px; /* Space between logo and title */
        }
        h1 {
            color: #2c3e50; /* Dark blue */
            text-align: center;
            margin-bottom: 30px;
        }
        h2 { /* Style for new process titles */
            color: #0056b3; /* Light blue */
            text-align: center;
            margin-top: 30px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 15px;
            text-align: left; /* Align labels and inputs to the left */
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333333; /* Dark grey/black */
        }
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #cccccc; /* Light grey border */
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
            padding-top: 3px;
            padding-bottom: 3px;
            background-color: #ffffff; /* White background for input */
        }
        button {
            background-color: #0056b3; /* Dark blue */
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1em;
            width: 100%;
            transition: background-color 0.3s ease;
            margin-top: 20px; /* Added spacing for buttons */
        }
        button:hover {
            background-color: #003d80; /* Slightly darker blue on hover */
        }
        .flash-messages {
            list-style-type: none;
            padding: 0;
            margin-bottom: 20px;
            width: 100%;
            max-width: 600px;
        }
        .flash-messages li {
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-weight: bold;
            text-align: left; /* Align flash message text to left */
        }
        .flash-messages li.error {
            background-color: #f8d7da; /* Light red */
            color: #721c24; /* Dark red */
            border: 1px solid #f5c6cb; /* Red border */
        }
        .flash-messages li.success {
            background-color: #d1ecf1; /* Light blue (info-like) */
            color: #0c5460; /* Dark blue (info-like) */
            border: 1px solid #bee5eb; /* Blue border */
        }
        .flash-messages li.info {
            background-color: #e2f0fb; /* Lighter blue */
            color: #1a4f8a; /* Medium blue */
            border: 1px solid #bce1fb; /* Blue border */
        }
        .download-links {
            margin-top: 20px;
            text-align: center;
        }
        .download-links h3 { /* Changed from h2 to h3 for download titles */
            color: #2c3e50; /* Dark blue */
            margin-bottom: 10px;
        }
        .download-links p {
            color: #333333; /* Dark grey/black */
            margin-bottom: 15px;
        }
        .download-links a {
            display: inline-block;
            background-color: #0056b3; /* Light blue */
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            text-decoration: none;
            margin: 5px;
            transition: background-color 0.3s ease;
        }
        .download-links a:hover {
            background-color: #003d80; /* Darker blue on hover */
        }
 
        /* Styles for the Modal (Rules Popup) */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center; /* Center content */
            align-items: center; /* Center content */
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto; /* Center horizontally and vertically */
            padding: 20px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 80%; /* Could be smaller or larger */
            max-width: 700px; /* Max width */
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
            animation-name: animatetop;
            animation-duration: 0.4s;
            color: #333; /* Default text color for rules content */
        }
        /* Add Animation */
        @keyframes animatetop {
            from {top: -300px; opacity: 0}
            to {top: 0; opacity: 1}
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-content h2 {
            color: #2c3e50; /* Dark blue for modal title */
            margin-top: 0;
            text-align: left;
            margin-bottom: 20px;
        }
        .modal-content h3 { /* New style for sub-headings in modal */
            color: #0056b3;
            margin-top: 20px;
            margin-bottom: 10px;
            text-align: left;
        }
        .modal-content ul {
            list-style-type: decimal;
            text-align: left;
            margin-left: 25px; /* Adjust indent for list items */
            padding-left: 0;
        }
        .modal-content ul li {
            margin-bottom: 12px; /* More space between rules */
            line-height: 1.4;
            color: #333; /* Black for general list items */
            font-size: 1em; /* Default font size for main list items */
        }
        .modal-content ul li strong {
            color: #0056b3; /* Dark blue for bold text within rules */
            font-weight: bold; /* Explicitly ensure bold */
        }
        /* For sub-lists within rules */
        .modal-content ul ul {
            list-style-type: disc; /* Use bullets for sub-lists */
            margin-top: 8px;
            margin-bottom: 8px;
            margin-left: 20px; /* Indent sub-list further */
        }
        .modal-content ul ul li {
            margin-bottom: 5px; /* Less space for sub-list items */
            color: #333; /* Black for sub-list items */
            font-size: 0.9em; /* One size smaller for sub-list items */
        }
        .rules-link {
            display: block;
            text-align: right;
            margin-top: -20px; /* Adjust as needed to position it */
            margin-bottom: 15px;
        }
        .rules-link a {
            color: #0056b3;
            text-decoration: none;
            font-weight: bold;
        }
        .rules-link a:hover {
            text-decoration: underline;
        }
 
    </style>
</head>
<body>
    <div class="container">
        <h1>Allocation & Lookup Application</h1>
 
        <div class="rules-link">
            <a href="#" id="openRulesModal">View Rules & Instructions</a>
        </div>
       
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flash-messages">
                    {% for category, message in messages %}
                        <li class="{{ category }}">{{ message }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        <!-- B-Segment Allocation Section -->
        <h2>B-Segment Allocation</h2>
        <form action="{{ url_for('route_process_b_segment_allocation') }}" method="post" enctype="multipart/form-data">
            <div class="form-group">
                <label for="pisa_file">Upload PISA Excel File (.xlsx):</label>
                <input type="file" name="pisa_file" id="pisa_file" accept=".xlsx" required>
            </div>
            <div class="form-group">
                <label for="esm_file">Upload ESM Excel File (.xlsx):</label>
                <input type="file" name="esm_file" id="esm_file" accept=".xlsx" required>
            </div>
            <div class="form-group">
                <label for="pm7_file">Upload PM7 Excel File (.xlsx):</label>
                <input type="file" name="pm7_file" id="pm7_file" accept=".xlsx" required>
            </div>
            <div class="form-group">
                <label for="workon_file">Upload Workon P71 Excel File (.xlsx) (Optional):</label>
                <input type="file" name="workon_file" id="workon_file" accept=".xlsx">
            </div>
            <div class="form-group">
                <label for="rgpa_file">Upload RGPA Excel File (.xlsx):</label>
                <input type="file" name="rgpa_file" id="rgpa_file" accept=".xlsx" required>
            </div>
            <div class="form-group">
                <label for="smd_file">Upload SMD Excel File (.xlsx) (Optional):</label>
                <input type="file" name="smd_file" id="smd_file" accept=".xlsx">
            </div>
            <div class="form-group">
                <label for="b_segment_central_file">Upload B-Segment Central Excel File (.xlsx):</label>
                <input type="file" name="b_segment_central_file" id="b_segment_central_file" accept=".xlsx" required>
            </div>
            <button type="submit">Process B-Segment Allocation</button>
        </form>
       
        {% if b_segment_download_link %}
            <div class="download-links">
                <h3>B-Segment Processing Complete!</h3>
                <p>Your processed B-Segment file is ready:</p>
                <a href="{{ b_segment_download_link }}" download>Download Updated B-Segment Central File</a>
            </div>
        {% endif %}

        <!-- PMD Lookup Section -->
        <h2>PMD Lookup</h2>
        <form action="{{ url_for('route_process_pmd_lookup') }}" method="post" enctype="multipart/form-data">
            <div class="form-group">
                <label for="pmd_central_file">Upload PMD Central Excel File (.xlsx):</label>
                <input type="file" name="pmd_central_file" id="pmd_central_file" accept=".xlsx" required>
            </div>
            <div class="form-group">
                <label for="pmd_lookup_file">Upload PMD Dump Excel File (.xlsx):</label>
                <input type="file" name="pmd_lookup_file" id="pmd_lookup_file" accept=".xlsx" required>
            </div>
            <button type="submit">Process PMD Lookup</button>
        </form>

        {% if pmd_lookup_download_link %}
            <div class="download-links">
                <h3>PMD Lookup Processing Complete!</h3>
                <p>Your processed PMD Lookup file is ready:</p>
                <a href="{{ pmd_lookup_download_link }}" download>Download PMD Lookup Result File</a>
            </div>
        {% endif %}
    </div>
 
    <!-- The Modal (Rules Popup) -->
    <div id="rulesModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Allocation Application Rules & Guidelines</h2>

            <h3>B-Segment Allocation Rules</h3>
            <ul>
                <li>All uploaded files <strong>must be in .xlsx format</strong>.</li>
                <li><strong>Tracker File Download:</strong> Download the tracker file when nobody is actively using it. Navigate to:
                    <strong>Teams channel</strong> &rarr; <strong>General</strong> &rarr; <strong>Files</strong> &rarr; <strong>PBI_Database</strong> &rarr; <strong>B-Segment</strong> &rarr; <code>New B_Segment(yesterday's date).xlsx</code></li>
                <li><strong>Tracker File Columns:</strong> Ensure the tracker file (B-Segment Central File) contains the following columns with <strong>exact naming</strong> (case-sensitive and including spaces):<br>
                    <code>Barcode</code>, <code>Processor</code>, <code>Channel</code>, <code>Category</code>, <code>Company code</code>, <code>Region</code>, <code>Vendor number</code>, <code>Vendor Name</code>, <code>Status</code>, <code>Received Date</code>, <code>Re-Open Date</code>, <code>Allocation Date</code>, <code>Clarification Date</code>, <code>Completion Date</code>, <code>Requester</code>, <code>Remarks</code>, <code>Aging</code>, <code>Today</code>.<br>
                    <strong>No filters should be applied</strong> in the downloaded tracker file.</li>
                <li><strong>ESM Mandatory Columns:</strong> After internal processing, the ESM file should contain the following columns:
                    <ul>
                        <li><strong>Company code</strong> (with a space after company)</li>
                        <li><strong>Subcategory</strong> (with no spacing between the words)</li>
                        <li><strong>Received date</strong> (with a space after received, mapped from 'Updated')</li>
                    </ul>
                </li>
                <li><strong>PISA Mandatory Columns:</strong> After internal processing, the PISA file should contain the following columns:
                    <ul>
                        <li><strong>Vendor name</strong> (with a space after vendor)</li>
                        <li><strong>Vendor number</strong> (with a space after vendor)</li>
                        <li><strong>Company code</strong> (with a space after company)</li>
                        <li><strong>Received date</strong> (with a space after received, mapped from 'Creation date')</li>
                    </ul>
                </li>
                <li><strong>PM7 Mandatory Columns:</strong> After internal processing, the PM7 file should contain the following columns:
                    <ul>
                        <li><strong>Vendor name</strong> (with a space after vendor)</li>
                        <li><strong>Vendor number</strong> (with a space after vendor)</li>
                        <li><strong>Company code</strong> (with a space after company)</li>
                        <li><strong>Received date</strong> (with a space after received, mapped from 'Creation date')</li>
                    </ul>
                </li>
                <li><strong>Workon P71 Mandatory Columns (Optional):</strong> If provided, the Workon P71 file should contain the following columns:
                    <ul>
                        <li><strong>key</strong> (mapped to Barcode)</li>
                        <li><strong>action</strong> (mapped to Category)</li>
                        <li><strong>company code</strong> (mapped to Company code)</li>
                        <li><strong>country</strong> (mapped to Region)</li>
                        <li><strong>vendor number</strong> (mapped to Vendor number)</li>
                        <li><strong>name</strong> (mapped to Vendor Name)</li>
                        <li><strong>status</strong> (mapped to Status)</li>
                        <li><strong>updated</strong> (mapped to Received Date)</li>
                        <li><strong>applicant</strong> (mapped to Requester)</li>
                        <li><strong>summary</strong> (mapped to Remarks)</li>
                    </ul>
                    For Workon P71 records, <strong>Processor</strong> will be set to "Jayapal" and <strong>Channel</strong> to "Workon". <strong>Allocation Date</strong> will be today's date. Other date/aging fields will be blank.
                </li>
                <li><strong>RGPA Mandatory Columns:</strong> After internal processing, the RGPA file should contain the following columns:
                    <ul>
                        <li><strong>key</strong> (mapped to Barcode)</li>
                        <li><strong>company code</strong> (mapped to Company code)</li>
                        <li><strong>updated</strong> (mapped to Received Date)</li>
                        <li><strong>summary</strong> (mapped to Remarks)</li>
                        <li><strong>current assignee</strong> (used for filtering)</li>
                    </ul>
                    Records will be filtered where <strong>'Current Assignee'</strong> is "VMD GS OSP-NA (GS/OMD-APAC)".
                    For RGPA records, <strong>Processor</strong> will be set to "Divya" and <strong>Channel</strong> to "RGPA". <strong>Allocation Date</strong> will be today's date. The <strong>Region</strong> will be automatically mapped based on the 'Company code' from the external mapping file. Other fields will be blank.
                </li>
                <li><strong>SMD Mandatory Columns (Optional):</strong> If provided, the SMD file should contain the following columns:
                    <ul>
                        <li><strong>ekorg</strong> (mapped to Company code)</li>
                        <li><strong>material field</strong> (mapped to Region)</li>
                        <li><strong>PMD-SNO</strong> (mapped to Vendor number)</li>
                        <li><strong>supplier name</strong> (mapped to Vendor Name)</li>
                        <li><strong>request date</strong> (mapped to Received Date)</li>
                        <li><strong>Requested by</strong> (mapped to Requester)</li>
                    </ul>
                    For SMD records, <strong>Channel</strong> will be "SMD". <strong>Allocation Date</strong> and <strong>Today</strong> will be today's date. All other fields (including Barcode, Processor, Category, Status, Re-Open Date, Clarification Date, Completion Date, Remarks, Aging) will be blank or empty, as per requirements.
                </li>
                <li><strong>Processing & Upload:</strong> Upload the ESM, PISA, PM7, RGPA, (optionally Workon P71 and SMD), and B-Segment Central files. Then, click on the <strong>"Process B-Segment Allocation"</strong> button. The new updated tracker file will be automatically downloaded and will be ready for allocation.</li>
                <li><strong>Post-Processing Actions:</strong>
                    <ul>
                        <li><strong>Rename & Upload:</strong> Replace the newly downloaded file by renaming it to <code>New B_Segment(DD_MM_YYYY)</code> with <strong>today's date</strong> in the Teams channel.</li>
                        <li><strong>Archive Old File:</strong> Move the <code>New B_Segment(DD_MM_YYYY)</code> with <strong>yesterday's date</strong> into the <strong><code>Old Data (Do not Modify)</code> folder</strong>.</li>
                    </ul>
                </li>
            </ul>

            <h3>PMD Lookup Rules</h3>
            <ul>
                <li>Both the <strong>PMD Central Excel File</strong> and the <strong>PMD Dump Excel File</strong> must be provided and in <strong>.xlsx format</strong>.</li>
                <li><strong>PMD Central File Mandatory Columns:</strong> Ensure the PMD Central file contains these columns with <strong>exact naming</strong> (case-sensitive and including spaces):
                    <ul>
                        <li><code>Valid From</code></li>
                        <li><code>Supplier Name</code></li>
                        <li><code>Status</code></li>
                        <li><code>Assigned</code></li>
                    </ul>
                </li>
                <li><strong>PMD Dump File Mandatory Columns:</strong> Ensure the PMD Dump file contains these columns with <strong>exact naming</strong>:
                    <ul>
                        <li><code>Valid From</code></li>
                        <li><code>Supplier Name</code></li>
                        <li>Optionally, other columns like <code>Bukr.</code>, <code>Type</code>, <code>EBSNO</code>, <code>Street</code>, <code>City</code>, <code>Country</code>, <code>Zip Code</code>, <code>Requested By</code>, <code>Pur. approver</code>, <code>Pur. release date</code> will be included in the output if present.</li>
                    </ul>
                </li>
                <li><strong>Processing Logic:</strong>
                    <ul>
                        <li>Records from the PMD Dump file are matched against the PMD Central file using a combination of <strong><code>Valid From</code> date and <code>Supplier Name</code></strong>.</li>
                        <li>If a record from the PMD Dump file is <strong>not found</strong> in the PMD Central file, its status will be set to <strong>"New"</strong>.</li>
                        <li>If a record from the PMD Dump file <strong>is found</strong> in the PMD Central file and its <code>Status</code> in the Central file is <strong>"Approved"</strong> (case-insensitive), this record will be <strong>ignored</strong> and will not appear in the output.</li>
                        <li>If a record from the PMD Dump file <strong>is found</strong> in the PMD Central file and its <code>Status</code> in the Central file is <strong>anything other than "Approved"</strong>, its status will be set to <strong>"Hold"</strong>, and the <code>Assigned</code> value from the Central file will be used.</li>
                    </ul>
                </li>
                <li><strong>Output:</strong> The output will be an Excel file named <code>PMD_Lookup_Result_DD_MM_YYYY_HHMMSS.xlsx</code> containing only the "New" and "Hold" records, with updated status and assignment where applicable.</li>
            </ul>
        </div>
    </div>
 
    <script>
        // Get the modal
        var modal = document.getElementById("rulesModal");
 
        // Get the button that opens the modal
        var btn = document.getElementById("openRulesModal");
 
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close-button")[0];
 
        // When the user clicks the button, open the modal
        btn.onclick = function() {
            modal.style.display = "flex"; // Use flex to center
        }
 
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
            modal.style.display = "none";
        }
 
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>
</body>
</html>
